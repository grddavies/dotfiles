#!/usr/bin/env bash
#
# Git tag a motilent report plugin
set -euo pipefail

source "$(dirname "$0")/git-common.sh"

# Convert kebab-case to SCREAMING_SNAKE_CASE
convert_to_screaming_snake() {
  echo "$1" | tr '-' '_' | tr '[:lower:]' '[:upper:]'
}

# Function to get the next pre-release index for a report version
# Args:
# tag_prefix: X.Y.X-QA_REPORT_NAME.
get_next_index() {
  local tag_prefix="$1"
  local last_tag
  last_tag=$(git tag --list "$tag_prefix*" | sort -V | tail -n 1)

  if [[ -z "$last_tag" ]]; then
    echo "001"
  else
    local current_index
    current_index=$(echo "$last_tag" | grep -oE '[0-9]{3}$')
    printf "%03d" $((10#$current_index + 1))
  fi
}

# If no args - print usage
if [[ $# -lt 1 ]]; then
  echo "Usage: $0 <x.y.z> [--qa] [--dry-run]"
  exit 1
fi

# Parse arguments
TAG_VERSION="$1"
IS_QA=false

for arg in "$@"; do
  case $arg in
  --qa)
    IS_QA=true
    ;;
  esac
done

assert_git_repo
assert_default_branch

# Get the repository directory name
REPO_NAME=$(basename "$(git rev-parse --show-toplevel)")
PRERELEASE_NAME=$(convert_to_screaming_snake "$REPO_NAME")

if $IS_QA; then
  TAG_PREFIX="$TAG_VERSION-QA_${PRERELEASE_NAME}."
  NEXT_INDEX=$(get_next_index "$TAG_PREFIX")
  NEW_TAG="$TAG_PREFIX$NEXT_INDEX"
  TICKET_NUMBER=$(extract_ticket_number)
else
  NEW_TAG="$TAG_VERSION"
  read -rp "Enter release ticket number: " TICKET_NUMBER
fi

COMMENT="https://jira.motilent.io/browse/$TICKET_NUMBER"

# Create the tag
echo "Creating tag: $NEW_TAG"
cmd="git tag -a $NEW_TAG -m \"$COMMENT\""

while true; do
  echo "Script will run the following command:"
  echo "$cmd"
  read -rp "Proceed? y/n" yn
  case $yn in
  [Yy]*)
    eval "$cmd"
    break
    ;;
  [Nn]*) exit ;;
  *) echo "Please answer yes or no." ;;
  esac
done
